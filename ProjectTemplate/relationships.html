<!DOCTYPE html>
<html lang="en">
<head>
    <title>Relationships</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="UniversalCSS.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="universal.css">

    <script type="text/javascript">
        function initialize() {
            var webMethod = "ProjectServices.asmx/isMentorCheck";
            var content = document.getElementById('contentID');

            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d) {
                        content.innerHTML = "<h2>Here are your mentees:</h2>";
                    }
                    else {
                        content.innerHTML = "<h2>Here are your mentors:</h2>" +
                        `<br><label>Enter mentor username</label><br>` +
                        `<input type = "text" id="mentorInputID">` +
                        `<button type="button" onclick = "addMentor($('#mentorInputID').val());">Add mentor</button><br><br>`;
                    }
                    
                    getPoints();
                    returnPairings();
                },
                error: function (e) {
                    alert("Issue!...");
                }
            });
        }

        // this will call a webservice function returning our matches
        function returnPairings() {
            var webMethod = "ProjectServices.asmx/returnPairings";
            var content = document.getElementById('contentID');

            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    let json_objs = JSON.parse(msg.d);

                    for (let i = 0; i < json_objs.length; i++) {
                        content.innerHTML += `<div id=${json_objs[i].username}><p>${json_objs[i].firstName} ${json_objs[i].lastName}<p>` +
                            `<label for="dateInputID">Add meeting date</label><br>` +
                            `<input type = "date" id="dateInputID">` +
                            `<button type="button" onclick = "scheduleMeeting($(this).closest('div').attr('id'), $(this).siblings('#dateInputID')[0].value)">Schedule</button></div><br><br>`;
                    }

                },
                error: function (e) {
                    alert("Issue!...");
                }
            });
        }

        // retrieves and displays the total number of points a user has available
        function getPoints() {
            var webMethod = "ProjectServices.asmx/getPoints";
            var points = document.getElementById('pointsTotal');

            $.ajax({
                type: "POST",
                url: webMethod,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    points.textContent += msg.d;
                },
                error: function (e) {
                    alert("Issue!...");
                }
            });
        }

        // this will take the mentor/mentee pair and schedule the meeting.
        function scheduleMeeting(otherUsername, date) {
            var webMethod = "ProjectServices.asmx/scheduleMeeting";
            var parameters = "{\"otherUsername\":\"" + encodeURI(otherUsername) + "\",\"date\":\"" + encodeURI(date) + "\"}";
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d) {
                        alert("Meeting added");
                    }
                    else {
                        alert("Meeting exists");
                    }
                },
                error: function (e) {
                    alert("Error!");
                }
                })
        }

        // takes mentor username and adds it to the mentee's list of mentors upon a button being clicked
        function addMentor(mentorUsername) {
            var webMethod = "ProjectServices.asmx/addMentor";
            var parameters = "{\"mentorUsername\":\"" + encodeURI(mentorUsername) + "\"}";
            $.ajax({
                type: "POST",
                url: webMethod,
                data: parameters,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (msg) {
                    if (msg.d == "Success") {
                        alert("Mentor added");
                        window.location.reload();
                    }
                    else {
                        alert(msg.d);
                    }
                },
                error: function (e) {
                    alert("Error!");
                }
                })
        }


    </script>

</head>
<body onload="initialize()">
    <nav class="navbar navbar-expand-sm bg-light">
        <a class="navbar-brand" href="#">
            <img src="logoSquare.png" alt="Logo" style="width:40px;">
        </a>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="meetingSurvey.html">Survey</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="shop.html">Shop</a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" id="pointsTotal" href="#">Points: </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Logout</a>
            </li>
        </ul>
    </nav>

    <div id="contentID">
    </div>

</body>
</html>